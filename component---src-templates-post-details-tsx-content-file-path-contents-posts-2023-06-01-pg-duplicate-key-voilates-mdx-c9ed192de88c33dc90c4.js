"use strict";(self.webpackChunknew_gatsby_blog=self.webpackChunknew_gatsby_blog||[]).push([[66,5899],{6481:function(e,t,n){n.r(t);var r=n(1151),l=n(7294);function a(e){const t=Object.assign({h2:"h2",p:"p",code:"code",pre:"pre",a:"a",ol:"ol",li:"li"},(0,r.ah)(),e.components);return l.createElement(l.Fragment,null,l.createElement(t.h2,null,"배경"),"\n",l.createElement(t.p,null,"postgresql db를 사용 중, backend에서 orm으로 create 명령을 실행할 때 문제가 발생했습니다. 바로 알아채지 못하고 검색이 필요했어서 앞으로 기억하기 위해 정리합니다."),"\n",l.createElement(t.h2,null,"문제"),"\n",l.createElement(t.p,null,"pg table에 row를 insert 하려고 할 때 ",l.createElement(t.code,null,"duplicate key value violates unique constrain PK_324238724")," 에러가 발생합니다.\n이는 쉽게 이야기하면, 내가 row를 하나 더 생성하려고 할 때, table 이 자동으로 부여하려고 하는 key가 중복된다는 뜻입니다. 다행히 이 문제를 쉽게 유추한 것은 위 테이블의 row를 제가 직접 조작한 적이 있었기 때문에, PK가 중복되는 이유는 내부의 key가 중복될 것이라 판단했기 때문입니다. 구글링을 해본 결과 역시 가장 확률이 높았고 postgresql의 sequence manipulation function을 실행해서 이 문제를 해결할 수 있었습니다."),"\n",l.createElement(t.h2,null,"Sequence Manipulation Functions"),"\n",l.createElement(t.p,null,"Sequences란?"),"\n",l.createElement(t.pre,null,l.createElement(t.code,null,"Sequence objects are special single-row tables created with CREATE SEQUENCE.\n")),"\n",l.createElement(t.p,null,l.createElement(t.a,{href:"https://www.postgresql.org/docs/current/functions-sequence.html"},"9.17. Sequence Manipulation Functions 공식 문서")),"\n",l.createElement(t.h2,null,"해결"),"\n",l.createElement(t.ol,null,"\n",l.createElement(t.li,null,"\n",l.createElement(t.p,null,"key 이름을 찾습니다."),"\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-sql"},'\n-- Sequence and defined type\nCREATE SEQUENCE IF NOT EXISTS table_id_seq;\n\n-- Table Definition\nCREATE TABLE "public"."table" (\n    "id" int4 NOT NULL DEFAULT nextval(\'table_id_seq\'::regclass),\n    "slug" varchar NOT NULL DEFAULT \'noname\'::character varying,\n    "description" text,\n    "create_datetime" timestamp NOT NULL DEFAULT now(),\n    PRIMARY KEY ("id")\n);\n')),"\n",l.createElement(t.p,null,"이런 식으로 create query를 조회해 보시면 table_id_seq라는 key를 알 수 있습니다."),"\n"),"\n",l.createElement(t.li,null,"\n",l.createElement(t.p,null,l.createElement(t.code,null,"select lastval() from 테이블 이름;")," 을 실행하면 현재 table에 설정된 key의 값을 알 수 있습니다. 보통 에러가 나는 경우에는 table에 특수한 조작으로 row를 이전에 insert해서 table 내부 table_id_seq값이 max(id)보다 작아서 이미 해당 id의 row가 존재함을 알 수 있습니다."),"\n"),"\n",l.createElement(t.li,null,"\n",l.createElement(t.p,null,l.createElement(t.code,null,"select setval('table_id_seq', (select max(id) from table));")," 쿼리를 실행해 키의 최대값을 재설정합니다."),"\n"),"\n",l.createElement(t.li,null,"\n",l.createElement(t.p,null,"이후에 아까 실행하려던 insert 쿼리를 생성하면 정상적으로 실행되는 것을 알 수 있습니다."),"\n"),"\n"),"\n",l.createElement(t.p,null,"끝!!!"),"\n",l.createElement(t.h2,null,"앞으로 할 일"),"\n",l.createElement(t.p,null,"그냥 typeorm에서는 ",l.createElement(t.code,null,"@PrimaryGeneratedColumn()")," 로 선언한 컬럼이 실제로는 Sequence를 생성한다는 사실을 알았습니다. orm에 너무 의존하다 보니 이렇게 에러를 만나게 되면 해결하기 쉽지 않은데요, 이렇게 만날 때마다 공부해 놓으면 될 것 같습니다."))}t.default=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,r.ah)(),e.components);return t?l.createElement(t,e,l.createElement(a,e)):a(e)}},6636:function(e,t,n){n.r(t),n.d(t,{default:function(){return v}});var r=n(6481),l=n(7462),a=n(4316),c=n(7294),o=n(1151),i=n(8899),u=n(917);const s=(0,a.Z)("h1",{target:"e5jkt9i12"})(""),m=(0,a.Z)("h2",{target:"e5jkt9i11"})({name:"7va4f6",styles:"margin:2rem 0 1rem"}),d=(0,a.Z)("h3",{target:"e5jkt9i10"})(""),p=(0,a.Z)("p",{target:"e5jkt9i9"})({name:"17ebupe",styles:"line-height:1.5rem;&>code{display:inline-block;background:transparent;padding:0 0.4rem;background:#fcf55f;border-radius:0;border:none;font-weight:bold;word-break:break-all;}"}),g=(0,a.Z)("code",{target:"e5jkt9i8"})(""),E=((0,a.Z)("pre",{target:"e5jkt9i7"})(""),(0,a.Z)("code",{target:"e5jkt9i6"})({name:"1gkxtoh",styles:"display:block;white-space:pre-wrap;word-wrap:break-word;background:#fbfbf4;padding:1rem 1rem;line-height:1.1rem;border:1px solid #999999;border-radius:8px;margin:0.5rem auto"})),b=(0,a.Z)("strong",{target:"e5jkt9i5"})({name:"1beyxqc",styles:"background:red;padding:1rem 1rem;line-height:1.1rem;border:1px solid #999999;border-radius:8px;margin:0.5rem auto"}),h=(0,a.Z)("img",{target:"e5jkt9i4"})({name:"1oax00r",styles:"margin:1rem 0"}),k=(0,a.Z)("a",{target:"e5jkt9i3"})({name:"1m5hyg0",styles:"word-break:break-all"}),f={h1:s,h2:m,h3:d,p:p,code:E,strong:b,blockquote:b,pre:g,img:h,a:e=>(0,u.tZ)(k,(0,l.Z)({},e,{target:"_blank",rel:"noopener noreferrer"}))},y=(0,a.Z)("div",{target:"e5jkt9i2"})({name:"d47c8v",styles:"padding:2.5rem 1rem 0.5rem 1rem;background:#e9e9e9"}),w=(0,a.Z)("section",{target:"e5jkt9i1"})({name:"okspu",styles:"padding:1rem;line-height:1.4rem"}),Z=(0,a.Z)("div",{target:"e5jkt9i0"})({name:"2qga7i",styles:"text-align:right"});function q(e){let{data:t,pageContext:n,children:r}=e;const{frontmatter:l}=t.mdx,{title:a,summary:c,featuredImg:s,tags:m,date:d}=l,[p,g]=new Date(d.replace(" ","T").replace(" ","")).toLocaleString().split("T");return(0,u.tZ)(i.Z,null,(0,u.tZ)(y,null,(0,u.tZ)("h1",null,a),(0,u.tZ)(Z,null,"발행일: ",p)),(0,u.tZ)(w,null,(0,u.tZ)(o.Zo,{components:f},r)))}function v(e){return c.createElement(q,e,c.createElement(r.default,e))}},1151:function(e,t,n){n.d(t,{Zo:function(){return o},ah:function(){return a}});var r=n(7294);const l=r.createContext({});function a(e){const t=r.useContext(l);return r.useMemo((()=>"function"==typeof e?e(t):{...t,...e}),[t,e])}const c={};function o({components:e,children:t,disableParentContext:n}){let o;return o=n?"function"==typeof e?e({}):e||c:a(e),r.createElement(l.Provider,{value:o},t)}}}]);
//# sourceMappingURL=component---src-templates-post-details-tsx-content-file-path-contents-posts-2023-06-01-pg-duplicate-key-voilates-mdx-c9ed192de88c33dc90c4.js.map